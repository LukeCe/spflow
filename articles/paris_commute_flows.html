<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Home-to-work commuting flows within the municipalities around Paris â€¢ spflow</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Home-to-work commuting flows within the municipalities around Paris">
<meta property="og:description" content="spflow">
<meta property="og:image" content="/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">spflow</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0.9010</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/paris_commute_flows.html">Home-to-work commuting flows within the municipalities around Paris</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/LukeCe/spflow/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Home-to-work commuting flows within the
municipalities around Paris</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/LukeCe/spflow/blob/HEAD/vignettes/paris_commute_flows.Rmd" class="external-link"><code>vignettes/paris_commute_flows.Rmd</code></a></small>
      <div class="hidden name"><code>paris_commute_flows.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This article illustrates the use of the <strong>spflow</strong>
package for modeling spatial interactions using the example of
home-to-work commuting flows. For our example we use information on the
71 municipalities that are located closest to the center of Paris. This
data is contained in the package and was originally diffused by the
French National Institutes of Statistics and Economic Studies (INSEE),
and of Geographic and Forest Information (IGN). (For more information
see <code><a href="../reference/paris_data.html">help(paris_data)</a></code>.)</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://Matrix.R-forge.R-project.org" class="external-link">"Matrix"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/LukeCe/spflow" class="external-link">"spflow"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://r-spatial.github.io/sf/" class="external-link">"sf"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/r-spatial/spdep/" class="external-link">"spdep"</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"paris10km_municipalities"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"paris10km_commuteflows"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-presentation">Data presentation<a class="anchor" aria-label="anchor" href="#data-presentation"></a>
</h2>
<p>Each municipality is identified by a unique id. Additionally, we have
information on the population, the median income and the number of
companies.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">drop_area</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">paris10km_municipalities</span><span class="op">)</span> <span class="op">!=</span> <span class="st">"AREA"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">paris10km_municipalities</span><span class="op">[</span><span class="va">drop_area</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="paris_commute_flows_files/figure-html/unnamed-chunk-2-1.png" width="720" style="display: block; margin: auto;"></p>
<p>There are three different neighborhood matrices that can be used to
describe the connectivity between the municipalities.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">old_par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mid_points</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_point_on_surface</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">paris10km_municipalities</span><span class="op">)</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">paris10km_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"by_contiguity"</span> <span class="op">=</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/poly2nb.html" class="external-link">poly2nb</a></span><span class="op">(</span><span class="va">paris10km_municipalities</span><span class="op">)</span>,</span>
<span>  <span class="st">"by_distance"</span> <span class="op">=</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/dnearneigh.html" class="external-link">dnearneigh</a></span><span class="op">(</span><span class="va">mid_points</span>,d1 <span class="op">=</span> <span class="fl">0</span>, d2 <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>  <span class="st">"by_knn"</span> <span class="op">=</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/knn2nb.html" class="external-link">knn2nb</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/knearneigh.html" class="external-link">knearneigh</a></span><span class="op">(</span><span class="va">mid_points</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">paris10km_municipalities</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">paris10km_nb</span><span class="op">$</span><span class="va">by_contiguity</span>, <span class="va">mid_points</span>, add <span class="op">=</span> <span class="cn">T</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,alpha<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"Contiguity"</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">paris10km_municipalities</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">paris10km_nb</span><span class="op">$</span><span class="va">by_distance</span>,<span class="va">mid_points</span>, add <span class="op">=</span> <span class="cn">T</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,alpha<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"Distance"</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">paris10km_municipalities</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">paris10km_nb</span><span class="op">$</span><span class="va">by_knn</span>, <span class="va">mid_points</span>, add <span class="op">=</span> <span class="cn">T</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,alpha<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"3 Nearest Neighbors"</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">old_par</span><span class="op">)</span></span></code></pre></div>
<p><img src="paris_commute_flows_files/figure-html/unnamed-chunk-3-1.png" width="720" style="display: block; margin: auto;"></p>
<p>Finally, there is data on the size of the commuting flows and the
distance between all pairs of municipalities</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">paris10km_commuteflows</span><span class="op">)</span></span>
<span><span class="co">#&gt;   ID_ORIG ID_DEST DISTANCE COMMUTE_FLOW</span></span>
<span><span class="co">#&gt; 1   75101   75101    0.000   3771.23556</span></span>
<span><span class="co">#&gt; 2   75101   75102  786.743    294.76899</span></span>
<span><span class="co">#&gt; 3   75101   75103 1729.063     71.25116</span></span>
<span><span class="co">#&gt; 4   75101   75104 1807.294     99.38468</span></span>
<span><span class="co">#&gt; 5   75101   75105 2266.598     98.88915</span></span>
<span><span class="co">#&gt; 6   75101   75106 1512.870     65.15406</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="modeling-spatial-interactions-with-spflow">Modeling Spatial Interactions with <code>spflow()</code><a class="anchor" aria-label="anchor" href="#modeling-spatial-interactions-with-spflow"></a>
</h2>
<p>The <strong>spflow</strong> package builds on the idea that flows
correspond to pairwise interactions between the nodes of an origin
network with the nodes of a destination network.</p>
<p>In our example, the origin and destination networks are the same
because every municipality is both an origin and destination of a
flow.</p>
<p>To estimate the model efficiently, the <strong>spflow</strong>
package uses moment-based estimation methods, that exploit the
relational structure of flow data. This avoids duplication arising from
the fact that each municipality is at the origin and destination of many
flows. For more details on the model and the estimation methods see
LeSage (2008), Dargel (2021) and Dargel (2022).</p>
<div class="section level3">
<h3 id="the-spflow-network-objects">The <code>spflow network objects</code><a class="anchor" aria-label="anchor" href="#the-spflow-network-objects"></a>
</h3>
<p>To describe the nodes of a network the package provides
<code>spflow_network-class</code> that combines attributes of the nodes
with the chosen network structure. For our model we choose the
contiguity based neighborhood structure.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">paris10km_net</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spflow_network.html">spflow_network</a></span><span class="op">(</span></span>
<span>    id_net <span class="op">=</span> <span class="st">"paris"</span>,</span>
<span>    node_neighborhood <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2mat.html" class="external-link">nb2mat</a></span><span class="op">(</span><span class="va">paris10km_nb</span><span class="op">$</span><span class="va">by_contiguity</span><span class="op">)</span>,</span>
<span>    node_data <span class="op">=</span> <span class="va">paris10km_municipalities</span>,</span>
<span>    node_key_column <span class="op">=</span> <span class="st">"ID_MUN"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">paris10km_net</span></span>
<span><span class="co">#&gt; Spatial network nodes with id: paris</span></span>
<span><span class="co">#&gt; --------------------------------------------------</span></span>
<span><span class="co">#&gt; Number of nodes: 71</span></span>
<span><span class="co">#&gt; Average number of links per node: 5.239</span></span>
<span><span class="co">#&gt; Density of the neighborhood matrix: 7.38% (non-zero connections)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Data on nodes:</span></span>
<span><span class="co">#&gt;     ID_MUN POPULATION MED_INCOME NB_COMPANY AREA COORD_X COORD_Y</span></span>
<span><span class="co">#&gt; 1    75101      17100   31842.56      14333  182    2.34   48.86</span></span>
<span><span class="co">#&gt; 2    75102      22390    30024.5      14478   99    2.34   48.87</span></span>
<span><span class="co">#&gt; 3    75103      35991      30988      10696  117    2.36   48.86</span></span>
<span><span class="co">#&gt; 4    75104      27769   30514.67       7412  160    2.36   48.85</span></span>
<span><span class="co">#&gt; 5    75105      60179      32950      10290  252    2.35   48.85</span></span>
<span><span class="co">#&gt; 6    75106      43224   38447.69      10620  215    2.33   48.85</span></span>
<span><span class="co">#&gt; ---    ---        ---        ---        ---  ---     ---     ---</span></span>
<span><span class="co">#&gt; 66   94046      54186      24329       3385  537    2.44    48.8</span></span>
<span><span class="co">#&gt; 67   94067      21846   31559.38       1763   90    2.42   48.84</span></span>
<span><span class="co">#&gt; 68   94069      14870   25790.65        957  144    2.43   48.82</span></span>
<span><span class="co">#&gt; 69   94076      56504      19447       2690  529    2.36   48.79</span></span>
<span><span class="co">#&gt; 70   94080      49831      30798       4655  191    2.43   48.85</span></span>
<span><span class="co">#&gt; 71   94081      88102    17860.5       4467 1166     2.4   48.79</span></span></code></pre></div>
<p>The <code>spflow_network_pair-class</code> contains all information
on the pairs of nodes belonging to the origin and destination
networks.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">paris10km_net_pairs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spflow_network_pair.html">spflow_network_pair</a></span><span class="op">(</span></span>
<span>  id_orig_net <span class="op">=</span> <span class="st">"paris"</span>,</span>
<span>  id_dest_net <span class="op">=</span> <span class="st">"paris"</span>,</span>
<span>  pair_data <span class="op">=</span> <span class="va">paris10km_commuteflows</span>,</span>
<span>  orig_key_column <span class="op">=</span> <span class="st">"ID_ORIG"</span>,</span>
<span>  dest_key_column <span class="op">=</span> <span class="st">"ID_DEST"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">paris10km_net_pairs</span></span>
<span><span class="co">#&gt; Spatial network pair with id: paris_paris</span></span>
<span><span class="co">#&gt; --------------------------------------------------</span></span>
<span><span class="co">#&gt; Origin network id: paris (with 71 nodes)</span></span>
<span><span class="co">#&gt; Destination network id: paris (with 71 nodes)</span></span>
<span><span class="co">#&gt; Number of pairs: 5041</span></span>
<span><span class="co">#&gt; Completeness of pairs: 100.00% (5041/5041)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Data on node-pairs:</span></span>
<span><span class="co">#&gt;      ID_DEST ID_ORIG DISTANCE COMMUTE_FLOW</span></span>
<span><span class="co">#&gt; 1      75101   75101        0      3771.24</span></span>
<span><span class="co">#&gt; 2      75102   75101   786.74       294.77</span></span>
<span><span class="co">#&gt; 3      75103   75101  1729.06        71.25</span></span>
<span><span class="co">#&gt; 4      75104   75101  1807.29        99.38</span></span>
<span><span class="co">#&gt; 5      75105   75101   2266.6        98.89</span></span>
<span><span class="co">#&gt; 6      75106   75101  1512.87        65.15</span></span>
<span><span class="co">#&gt; ---      ---     ---      ---          ---</span></span>
<span><span class="co">#&gt; 5036   94046   94081  3742.08       218.66</span></span>
<span><span class="co">#&gt; 5037   94067   94081  6105.73        60.28</span></span>
<span><span class="co">#&gt; 5038   94069   94081  4535.03       102.04</span></span>
<span><span class="co">#&gt; 5039   94076   94081  2567.25      1067.62</span></span>
<span><span class="co">#&gt; 5040   94080   94081  7277.43       120.11</span></span>
<span><span class="co">#&gt; 5041   94081   94081        0      9257.91</span></span></code></pre></div>
<p>The <code>spflow_network_multi-class</code> combines information on
the nodes and the node-pairs and also ensures that both data sources are
consistent. For example, if some of the origins in the
<code>spflow_network_pair-class</code> are not identified with the nodes
in the <code>spflow_network-class</code> an error will be raised.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">paris10km_multinet</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spflow_network_multi.html">spflow_network_multi</a></span><span class="op">(</span><span class="va">paris10km_net</span>,<span class="va">paris10km_net_pairs</span><span class="op">)</span></span>
<span><span class="va">paris10km_multinet</span></span>
<span><span class="co">#&gt; Collection of spatial network nodes and pairs</span></span>
<span><span class="co">#&gt; --------------------------------------------------</span></span>
<span><span class="co">#&gt; Contains 1 spatial network nodes  </span></span>
<span><span class="co">#&gt;     With id :  paris</span></span>
<span><span class="co">#&gt; Contains 1 spatial network pairs  </span></span>
<span><span class="co">#&gt;     With id :  paris_paris</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Availability of origin-destination pair information:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  ID_ORIG_NET ID_DEST_NET ID_NET_PAIR COMPLETENESS   C_PAIRS C_ORIG C_DEST</span></span>
<span><span class="co">#&gt;        paris       paris paris_paris      100.00% 5041/5041  71/71  71/71</span></span></code></pre></div>
<p>Given the information on origins, destinations and OD pairs we can
use the <code><a href="../reference/spflow_map.html">spflow_map()</a></code> method for a simple geographic
representation of the largest flows.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">paris10km_municipalities</span><span class="op">$</span><span class="va">geometry</span><span class="op">)</span> <span class="co"># polygons as background</span></span>
<span><span class="fu"><a href="../reference/spflow_map.html">spflow_map</a></span><span class="op">(</span></span>
<span>  <span class="va">paris10km_multinet</span>,</span>
<span>  flow_var <span class="op">=</span> <span class="st">"COMMUTE_FLOW"</span>,</span>
<span>  add <span class="op">=</span> <span class="cn">TRUE</span>,          <span class="co"># add to existing background</span></span>
<span>  legend_position <span class="op">=</span> <span class="st">"bottomleft"</span>,</span>
<span>  filter_lowest <span class="op">=</span> <span class="fl">.95</span>, <span class="co"># concentrate on the 5% largest</span></span>
<span>  remove_intra <span class="op">=</span> <span class="cn">TRUE</span>,  <span class="co"># intra-municipality flows are too large</span></span>
<span>  cex <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="paris_commute_flows_files/figure-html/unnamed-chunk-8-1.png" width="768" style="display: block; margin: auto;"></p>
<p>Before estimating a model we should investigate the correlation
structure of the input data. The <code><a href="../reference/pair_cor.html">pair_cor()</a></code> method creates
a correlation matrix, which we can represent using the
<code><a href="../reference/cor_image.html">cor_image()</a></code>. The formula is used clarify which variables
should be included in the correlation matrix. The details of how to use
this formula are explained later in this vignette and documented in
<code><a href="../reference/spflow.html">?spflow</a></code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cor_formula</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">COMMUTE_FLOW</span><span class="op">)</span> <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="fu">P_</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">DISTANCE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cor_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pair_cor.html">pair_cor</a></span><span class="op">(</span><span class="va">paris10km_multinet</span>, spflow_formula <span class="op">=</span> <span class="va">cor_formula</span>, add_lags_x <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">cor_mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">cor_mat</span><span class="op">)</span>,<span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span>,<span class="st">"..."</span><span class="op">)</span> <span class="co">#truncate top labels</span></span>
<span><span class="fu"><a href="../reference/cor_image.html">cor_image</a></span><span class="op">(</span><span class="va">cor_mat</span><span class="op">)</span></span></code></pre></div>
<p><img src="paris_commute_flows_files/figure-html/unnamed-chunk-9-1.png" width="720" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="estimation">Estimation<a class="anchor" aria-label="anchor" href="#estimation"></a>
</h3>
<p>The core function of the package is <code><a href="../reference/spflow.html">spflow()</a></code>, which
provides an interface to four different estimators of the spatial
econometric interaction model.</p>
<div class="section level4">
<h4 id="estimating-with-default-values">Estimating with default values<a class="anchor" aria-label="anchor" href="#estimating-with-default-values"></a>
</h4>
<p>Estimation with default settings requires two arguments: a
<code>spflow_network_multi-class</code> and a
<code>spflow_formula</code>. The <code>spflow_formula</code> specifies
the model we want to estimate. In this example, the dependent variable
is a transformation of commuting flows and we use the do- shortcut to
indicate that all available variables should be included in the model.
Using the defaults leads to the most comprehensive spatial interaction
model, which includes spatial lags of the dependent variable, the
exogenous variables and additional attributes for intra-regional
observations.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results_default</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spflow.html">spflow</a></span><span class="op">(</span></span>
<span>  spflow_formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">COMMUTE_FLOW</span><span class="op">)</span> <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="fu">P_</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">DISTANCE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  spflow_networks <span class="op">=</span> <span class="va">paris10km_multinet</span><span class="op">)</span></span>
<span></span>
<span><span class="va">results_default</span></span>
<span><span class="co">#&gt; --------------------------------------------------</span></span>
<span><span class="co">#&gt; Spatial interaction model estimated by: MLE  </span></span>
<span><span class="co">#&gt; Spatial correlation structure: SDM (model_9)</span></span>
<span><span class="co">#&gt; Dependent variable: log(1 + COMMUTE_FLOW)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --------------------------------------------------</span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;                         est     sd   t.stat  p.val</span></span>
<span><span class="co">#&gt; rho_d                 0.439  0.016   27.834  0.000</span></span>
<span><span class="co">#&gt; rho_o                 0.796  0.010   82.408  0.000</span></span>
<span><span class="co">#&gt; rho_w                -0.372  0.020  -18.226  0.000</span></span>
<span><span class="co">#&gt; (Intercept)          -0.158  0.073   -2.168  0.030</span></span>
<span><span class="co">#&gt; (Intra)               6.179  0.296   20.908  0.000</span></span>
<span><span class="co">#&gt; D_POPULATION          0.000  0.000    4.254  0.000</span></span>
<span><span class="co">#&gt; D_POPULATION.lag1     0.000  0.000   -0.170  0.865</span></span>
<span><span class="co">#&gt; D_MED_INCOME          0.000  0.000   -2.422  0.015</span></span>
<span><span class="co">#&gt; D_MED_INCOME.lag1     0.000  0.000    6.300  0.000</span></span>
<span><span class="co">#&gt; D_NB_COMPANY          0.000  0.000    2.437  0.015</span></span>
<span><span class="co">#&gt; D_NB_COMPANY.lag1     0.000  0.000    2.542  0.011</span></span>
<span><span class="co">#&gt; D_AREA                0.000  0.000    6.368  0.000</span></span>
<span><span class="co">#&gt; D_AREA.lag1           0.000  0.000   -4.319  0.000</span></span>
<span><span class="co">#&gt; O_POPULATION          0.000  0.000   22.902  0.000</span></span>
<span><span class="co">#&gt; O_POPULATION.lag1     0.000  0.000   -5.740  0.000</span></span>
<span><span class="co">#&gt; O_MED_INCOME          0.000  0.000    0.609  0.542</span></span>
<span><span class="co">#&gt; O_MED_INCOME.lag1     0.000  0.000    0.192  0.848</span></span>
<span><span class="co">#&gt; O_NB_COMPANY          0.000  0.000   -5.610  0.000</span></span>
<span><span class="co">#&gt; O_NB_COMPANY.lag1     0.000  0.000    1.050  0.294</span></span>
<span><span class="co">#&gt; O_AREA                0.000  0.000    6.278  0.000</span></span>
<span><span class="co">#&gt; O_AREA.lag1           0.000  0.000   -4.951  0.000</span></span>
<span><span class="co">#&gt; I_POPULATION          0.000  0.000   -3.538  0.000</span></span>
<span><span class="co">#&gt; I_MED_INCOME          0.000  0.000   -8.722  0.000</span></span>
<span><span class="co">#&gt; I_NB_COMPANY          0.000  0.000    4.787  0.000</span></span>
<span><span class="co">#&gt; I_AREA               -0.001  0.000   -5.401  0.000</span></span>
<span><span class="co">#&gt; P_log(1 + DISTANCE)      NA     NA       NA     NA</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --------------------------------------------------</span></span>
<span><span class="co">#&gt; R2_corr: 0.9110008  </span></span>
<span><span class="co">#&gt; Observations: 5041  </span></span>
<span><span class="co">#&gt; Model coherence: Validated</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="adjusting-the-formula">Adjusting the formula<a class="anchor" aria-label="anchor" href="#adjusting-the-formula"></a>
</h4>
<p>We can adjust how the exogenous variables are to be used by wrapping
them into the <code>D_()</code>, <code>O_()</code>, <code>I_()</code>
and <code>P_()</code> functions. The variables in <code>P_()</code> are
used as OD pair features and those in <code>D_()</code>,
<code>O_()</code> and <code>I_()</code> are used as destination, origin
and intra-regional features. We can take advantage of the formula
interface to specify transformations and expand factor variables to
dummies.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clog</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">log_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">log_x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">log_x</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">spflow_formula</span>  <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">COMMUTE_FLOW</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">~</span></span>
<span>  <span class="fu">D_</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">NB_COMPANY</span><span class="op">)</span> <span class="op">+</span> <span class="fu">clog</span><span class="op">(</span><span class="va">MED_INCOME</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">O_</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">POPULATION</span><span class="op">)</span> <span class="op">+</span> <span class="fu">clog</span><span class="op">(</span><span class="va">MED_INCOME</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">I_</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">POPULATION</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">P_</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">DISTANCE</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">results_mle</span>  <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spflow.html">spflow</a></span><span class="op">(</span></span>
<span>  <span class="va">spflow_formula</span>,</span>
<span>  <span class="va">paris10km_multinet</span><span class="op">)</span></span>
<span><span class="va">results_mle</span></span>
<span><span class="co">#&gt; --------------------------------------------------</span></span>
<span><span class="co">#&gt; Spatial interaction model estimated by: MLE  </span></span>
<span><span class="co">#&gt; Spatial correlation structure: SDM (model_9)</span></span>
<span><span class="co">#&gt; Dependent variable: log(COMMUTE_FLOW + 1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --------------------------------------------------</span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;                             est     sd   t.stat  p.val</span></span>
<span><span class="co">#&gt; rho_d                     0.213  0.019   11.150  0.000</span></span>
<span><span class="co">#&gt; rho_o                     0.726  0.012   59.127  0.000</span></span>
<span><span class="co">#&gt; rho_w                    -0.022  0.024   -0.904  0.366</span></span>
<span><span class="co">#&gt; (Intercept)              -0.809  0.289   -2.796  0.005</span></span>
<span><span class="co">#&gt; (Intra)                   6.829  0.893    7.646  0.000</span></span>
<span><span class="co">#&gt; D_log(NB_COMPANY)         0.285  0.016   18.075  0.000</span></span>
<span><span class="co">#&gt; D_log(NB_COMPANY).lag1   -0.220  0.022  -10.099  0.000</span></span>
<span><span class="co">#&gt; D_clog(MED_INCOME)       -0.343  0.051   -6.663  0.000</span></span>
<span><span class="co">#&gt; D_clog(MED_INCOME).lag1   0.509  0.073    6.959  0.000</span></span>
<span><span class="co">#&gt; O_log(POPULATION)         0.763  0.021   36.230  0.000</span></span>
<span><span class="co">#&gt; O_log(POPULATION).lag1   -0.649  0.031  -21.085  0.000</span></span>
<span><span class="co">#&gt; O_clog(MED_INCOME)       -0.081  0.050   -1.631  0.103</span></span>
<span><span class="co">#&gt; O_clog(MED_INCOME).lag1  -0.006  0.066   -0.094  0.925</span></span>
<span><span class="co">#&gt; I_log(POPULATION)        -0.422  0.082   -5.178  0.000</span></span>
<span><span class="co">#&gt; P_log(DISTANCE + 1)      -0.073  0.022   -3.257  0.001</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --------------------------------------------------</span></span>
<span><span class="co">#&gt; R2_corr: 0.9207571  </span></span>
<span><span class="co">#&gt; Observations: 5041  </span></span>
<span><span class="co">#&gt; Model coherence: Validated</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="fine-grained-control-with-spflow_control">Fine-grained control with <code>spflow_control()</code><a class="anchor" aria-label="anchor" href="#fine-grained-control-with-spflow_control"></a>
</h4>
<p>More fine-grained adjustments are possible via the
<code>spflow_control</code> argument. Here we change the estimation
method and the way we want to model the spatial autoregression in the
flows. To use spatial lags only for certain variables, we need to
specify them as a second formula.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sdm_formula</span> <span class="op">&lt;-</span> <span class="op">~</span></span>
<span>  <span class="fu">O_</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">POPULATION</span><span class="op">)</span> <span class="op">+</span> <span class="fu">clog</span><span class="op">(</span><span class="va">MED_INCOME</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">D_</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">NB_COMPANY</span><span class="op">)</span> <span class="op">+</span> <span class="fu">clog</span><span class="op">(</span><span class="va">MED_INCOME</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cntrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spflow_control.html">spflow_control</a></span><span class="op">(</span></span>
<span>  estimation_method <span class="op">=</span> <span class="st">"mcmc"</span>,</span>
<span>  sdm_variables <span class="op">=</span> <span class="va">sdm_formula</span>,</span>
<span>  model <span class="op">=</span> <span class="st">"model_7"</span><span class="op">)</span> <span class="co"># restricts \rho_w = 0</span></span>
<span></span>
<span><span class="va">results_mcmc</span>  <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spflow.html">spflow</a></span><span class="op">(</span></span>
<span>  <span class="va">spflow_formula</span>,</span>
<span>  <span class="va">paris10km_multinet</span>,</span>
<span>  estimation_control <span class="op">=</span> <span class="va">cntrl</span><span class="op">)</span></span>
<span></span>
<span><span class="va">results_mcmc</span></span>
<span><span class="co">#&gt; --------------------------------------------------</span></span>
<span><span class="co">#&gt; Spatial interaction model estimated by: MCMC  </span></span>
<span><span class="co">#&gt; Spatial correlation structure: SDM (model_7)</span></span>
<span><span class="co">#&gt; Dependent variable: log(COMMUTE_FLOW + 1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --------------------------------------------------</span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;                             est  quant_025  quant_975     sd</span></span>
<span><span class="co">#&gt; rho_d                     0.202      0.174      0.229  0.014</span></span>
<span><span class="co">#&gt; rho_o                     0.723      0.698      0.745  0.012</span></span>
<span><span class="co">#&gt; (Intercept)              -0.761     -1.328     -0.188  0.290</span></span>
<span><span class="co">#&gt; (Intra)                   6.851      5.143      8.518  0.880</span></span>
<span><span class="co">#&gt; D_log(NB_COMPANY)         0.290      0.260      0.319  0.015</span></span>
<span><span class="co">#&gt; D_log(NB_COMPANY).lag1   -0.231     -0.267     -0.193  0.019</span></span>
<span><span class="co">#&gt; D_clog(MED_INCOME)       -0.344     -0.448     -0.244  0.051</span></span>
<span><span class="co">#&gt; D_clog(MED_INCOME).lag1   0.505      0.361      0.652  0.073</span></span>
<span><span class="co">#&gt; O_log(POPULATION)         0.774      0.741      0.807  0.017</span></span>
<span><span class="co">#&gt; O_log(POPULATION).lag1   -0.667     -0.715     -0.621  0.024</span></span>
<span><span class="co">#&gt; O_clog(MED_INCOME)       -0.082     -0.178      0.018  0.050</span></span>
<span><span class="co">#&gt; O_clog(MED_INCOME).lag1  -0.002     -0.137      0.127  0.065</span></span>
<span><span class="co">#&gt; I_log(POPULATION)        -0.421     -0.578     -0.263  0.080</span></span>
<span><span class="co">#&gt; P_log(DISTANCE + 1)      -0.067     -0.110     -0.023  0.022</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --------------------------------------------------</span></span>
<span><span class="co">#&gt; R2_corr: 0.9205982  </span></span>
<span><span class="co">#&gt; Observations: 5041  </span></span>
<span><span class="co">#&gt; Model coherence: Validated</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="visualisations-to-diagnose-the-fit">Visualisations to diagnose the fit<a class="anchor" aria-label="anchor" href="#visualisations-to-diagnose-the-fit"></a>
</h3>
<p>Calling <code>plot(results_mcmc)</code> would create a whole sequence
of graphics that allow to diagnose the fit. Here we concentrate on a
selection of these graphics. The pairwise correlations of the model data
show, for example, that the residuals and their spatial lags are not
correlated with the explanatory variables.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_corr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pair_cor.html">pair_cor</a></span><span class="op">(</span><span class="va">results_mcmc</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">res_corr</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">res_corr</span><span class="op">)</span>,<span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/cor_image.html">cor_image</a></span><span class="op">(</span><span class="va">res_corr</span><span class="op">)</span></span></code></pre></div>
<p><img src="paris_commute_flows_files/figure-html/unnamed-chunk-13-1.png" width="720" style="display: block; margin: auto;"></p>
<p>We can also create Moran scatter plots to check whether the residuals
still exhibit spatial autocorrelation with respect to the three
potential neighborhood matrices <span class="math inline">\(W_d\)</span>, <span class="math inline">\(W_o\)</span> and <span class="math inline">\(W_w\)</span>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">old_par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/spflow_moran_plots.html">spflow_moran_plots</a></span><span class="op">(</span><span class="va">results_mcmc</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">old_par</span><span class="op">)</span></span></code></pre></div>
<p><img src="paris_commute_flows_files/figure-html/unnamed-chunk-14-1.png" width="720" style="display: block; margin: auto;"></p>
<p>A quick investigation of the 2% residuals with largest magnitude
reveals that long distances seem to be predicted with lower
precision.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">paris10km_municipalities</span><span class="op">$</span><span class="va">geometry</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/spflow_map.html">spflow_map</a></span><span class="op">(</span></span>
<span>  <span class="va">results_mcmc</span>,</span>
<span>  add <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  legend_position <span class="op">=</span> <span class="st">"bottomleft"</span>,</span>
<span>  filter_lowest <span class="op">=</span> <span class="fl">.98</span>, <span class="co"># concentrate on the 2% largest (in magnitude)</span></span>
<span>  cex <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> </span></code></pre></div>
<p><img src="paris_commute_flows_files/figure-html/unnamed-chunk-15-1.png" width="768" style="display: block; margin: auto;"></p>
<p>Looking at the relation between the distances and the error confirms
this impression. A more complex model could account for the increasing
variance by weighting the observations during the estimation. This could
be achieved using the <code>weight_variable</code> option in
<code><a href="../reference/spflow_control.html">spflow_control()</a></code>, but is left out in this introductory
vignette.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="../reference/spflow_generics.html">dat</a></span><span class="op">(</span><span class="va">paris10km_multinet</span>, <span class="st">"paris_paris"</span><span class="op">)</span><span class="op">[[</span><span class="st">"DISTANCE"</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">resid</a></span><span class="op">(</span><span class="va">results_mcmc</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="paris_commute_flows_files/figure-html/unnamed-chunk-16-1.png" width="720" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="evaluating-the-impact-of-changing-the-input-data">Evaluating the impact of changing the input data<a class="anchor" aria-label="anchor" href="#evaluating-the-impact-of-changing-the-input-data"></a>
</h3>
<p>Finally we can evaluate the impact certain characteristics have on
the outcome. Here we look at a scenario where the population in the
central municipality is increased by 10%. As this has diverse effects on
all flows we will first look at an image of the effect matrix. For a
more detailed treatment of the effect decomposition in the spatial
econometric interaction model see and .</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">center_mun</span> <span class="op">&lt;-</span> <span class="st">"75101"</span></span>
<span><span class="va">change_paris</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spflow_generics.html">dat</a></span><span class="op">(</span><span class="va">paris10km_multinet</span>, <span class="st">"paris"</span><span class="op">)</span></span>
<span><span class="va">change_paris</span> <span class="op">&lt;-</span> <span class="va">change_paris</span><span class="op">[</span><span class="va">change_paris</span><span class="op">$</span><span class="va">ID_MUN</span> <span class="op">==</span> <span class="va">center_mun</span>,<span class="op">]</span></span>
<span><span class="va">change_paris</span><span class="op">[</span>,<span class="st">"POPULATION"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">change_paris</span><span class="op">[</span>,<span class="st">"POPULATION"</span><span class="op">]</span><span class="op">*</span><span class="fl">1.1</span></span>
<span><span class="va">change_paris</span> <span class="op">&lt;-</span> <span class="va">change_paris</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span> <span class="co"># keep the ID and the variable that changed</span></span>
<span></span>
<span><span class="va">effect_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict.html">predict_effect</a></span><span class="op">(</span></span>
<span>  <span class="va">results_mcmc</span>,                           <span class="co"># the model</span></span>
<span>  new_dat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"paris"</span> <span class="op">=</span> <span class="va">change_paris</span><span class="op">)</span>, <span class="co"># changes in network "paris"</span></span>
<span>  return_type <span class="op">=</span> <span class="st">"M"</span><span class="op">)</span>                      <span class="co"># return in matrix form</span></span>
<span>  </span>
<span></span>
<span><span class="co"># in the first row are those flows that go to the center</span></span>
<span><span class="co"># in the first column are those flows that start from the center</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="va">effect_matrix</span><span class="op">)</span></span></code></pre></div>
<p><img src="paris_commute_flows_files/figure-html/unnamed-chunk-17-1.png" width="720" style="display: block; margin: auto;"></p>
<p>Here we see that flows starting from the center increase and flows
that start from neighbors of the center to the center decrease. All
other effects are very small. We can then have a closer look at the
flows that start from the center or go to it. Additionally we look at
all the internal flows, which decrease for all municipalities except for
the center.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="st">"FLOWS_FROM_CENTER"</span> <span class="op">=</span> <span class="va">effect_matrix</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">paris10km_municipalities</span><span class="op">[</span><span class="st">"geometry"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="paris_commute_flows_files/figure-html/unnamed-chunk-18-1.png" width="720" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="st">"FLOWS_TO_CENTER"</span> <span class="op">=</span> <span class="va">effect_matrix</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span>, <span class="va">paris10km_municipalities</span><span class="op">[</span><span class="st">"geometry"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="paris_commute_flows_files/figure-html/unnamed-chunk-18-2.png" width="720" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="st">"INTRA_FLOWS"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">effect_matrix</span><span class="op">)</span>, <span class="va">paris10km_municipalities</span><span class="op">[</span><span class="st">"geometry"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="paris_commute_flows_files/figure-html/unnamed-chunk-18-3.png" width="720" style="display: block; margin: auto;"></p>
<p>We can then look at the indirect effects on all flows that do not
have the central municipality as origin or destination. To summarize
these by total inflow and outflow we additionally set the internal flows
to zero.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">effect_matrix2</span> <span class="op">&lt;-</span> <span class="va">effect_matrix</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">effect_matrix2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">effect_matrix2</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="va">effect_matrix2</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="st">"TOTAL_OUTFLOWS"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">effect_matrix2</span><span class="op">)</span>, <span class="va">paris10km_municipalities</span><span class="op">[</span><span class="st">"geometry"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="paris_commute_flows_files/figure-html/unnamed-chunk-19-1.png" width="720" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="st">"TOTAL_INFLOWS"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">effect_matrix2</span><span class="op">)</span>, <span class="va">paris10km_municipalities</span><span class="op">[</span><span class="st">"geometry"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="paris_commute_flows_files/figure-html/unnamed-chunk-19-2.png" width="720" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Dargel L, Thomas-Agnan C (2022). â€œA generalized framework for
estimating spatial econometric interaction models.â€ TSE Working Paper,
n.Â 22-1312, <a href="https://www.tse-fr.eu/publications/generalized-framework-estimating-spatial-econometric-interaction-models" class="external-link uri">https://www.tse-fr.eu/publications/generalized-framework-estimating-spatial-econometric-interaction-models</a>.</p>
<p>Goulard M, Laurent T, Thomas-Agnan C (2017). â€œAbout predictions in
spatial autoregressive models: optimal and almost optimal strategies.â€
Spatial Economic Analysis, 304â€“325. <a href="https://doi.org/10.1080/17421772.2017.1300679" class="external-link uri">https://doi.org/10.1080/17421772.2017.1300679</a>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Lukas Dargel, Thibault Laurent.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
